<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Info Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* bot_info í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ (ë‚˜ë¨¸ì§€ëŠ” style.css ì°¸ì¡°) */
    </style>
    <script>
        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
        function formatCurrency(input, currencySymbol) {
            let value = input.value.replace(/[^0-9.]/g, '');
            if ((value.match(/\./g) || []).length > 1) {
                value = value.replace(/\.+$/, '');
            }
            if (!isNaN(value) && value !== "") {
                const parts = value.split('.');
                parts[0] = parseInt(parts[0], 10).toLocaleString('en-US');
                input.value = currencySymbol + parts.join('.');
            } else {
                input.value = currencySymbol;
            }
            input.selectionStart = input.selectionEnd = input.value.length;
        }

        function parseCurrency(value) {
            return parseFloat(value.replace(/[^0-9.]/g, '')) || 0;
        }

        // ì´ ì‹œë“œ ê³„ì‚°
        function updateTotalSeed(card) {
            const seedInput = card.querySelector('input[name="seed"]');
            const maxTierInput = card.querySelector('input[name="max_tier"]');
            const totalSeedInput = card.querySelector('input[name="total_seed"]');

            if (!seedInput || !maxTierInput || !totalSeedInput) return;

            const seedValue = parseFloat(seedInput.value.replace(/[^0-9.]/g, '')) || 0;
            const maxTierValue = parseInt(maxTierInput.value) || 0;

            const total = seedValue * maxTierValue;
            totalSeedInput.value = total ? '$ ' + total.toLocaleString('en-US') : '';
        }

        // ê°œë³„ bot ì €ì¥
        function saveBotInfo(button) {
            const card = button.closest('.bot-card');
            const data = {
                name: card.querySelector('input[name="name"]').value,
                symbol: card.querySelector('input[name="symbol"]').value,
                seed: parseCurrency(card.querySelector('input[name="seed"]').value),
                max_tier: parseInt(card.querySelector('input[name="max_tier"]').value) || 0,
                profit_rate: parseFloat(card.querySelector('input[name="profit_rate"]').value) || 0,
                t_div: parseInt(card.querySelector('input[name="t_div"]').value) || 0,
                is_check_buy_avr_price: card.querySelector('input[name^="is_check_buy_avr_price"]').checked,
                is_check_buy_t_div_price: card.querySelector('input[name^="is_check_buy_t_div_price"]').checked,
                active: card.querySelector('input[name^="active"]').checked,
                skip_sell: card.querySelector('input[name^="skip_sell"]').checked,
                point_loc: card.querySelector('input[name^="point_loc"]:checked').value
            };

            showLoading();
            fetch('/save_bot_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                alert(data.message || data.error);
                if (!data.error) location.reload();
            })
            .catch(error => {
                hideLoading();
                alert('Error: ' + error);
            });
        }

        // ê°œë³„ bot ì‚­ì œ
        function deleteBotInfo(button, name) {
            if (!confirm(name + 'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            showLoading();
            fetch('/delete_bot_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: name})
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                alert(data.message || data.error);
                if (!data.error) location.reload();
            })
            .catch(error => {
                hideLoading();
                alert('Error: ' + error);
            });
        }

        // ìƒˆë¡œìš´ bot ì¶”ê°€
        function addNewBot(button) {
            const card = button.closest('.bot-card');
            const name = card.querySelector('input[name="name"]').value;
            const symbol = card.querySelector('input[name="symbol"]').value;
            const seed = parseCurrency(card.querySelector('input[name="seed"]').value);

            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!seed || seed <= 0) {
                alert('SeedëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const data = {
                name: name,
                symbol: symbol,
                seed: seed,
                max_tier: parseInt(card.querySelector('input[name="max_tier"]').value) || 0,
                profit_rate: parseFloat(card.querySelector('input[name="profit_rate"]').value) || 0,
                t_div: parseInt(card.querySelector('input[name="t_div"]').value) || 0
            };

            showLoading();
            fetch('/add_bot_info', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                alert(data.message || data.error);
                if (!data.error) location.reload();
            })
            .catch(error => {
                hideLoading();
                alert('Error: ' + error);
            });
        }

        // ëª¨ë“  ì„¤ì • ì €ì¥
        function saveAllSettings() {
            const tradeStart = document.querySelector('input[name="trade_start"]').value.trim();
            const tradeEnd = document.querySelector('input[name="trade_end"]').value.trim();
            const twapCount = parseInt(document.querySelector('input[name="twap_count"]').value);

            if (!tradeStart || !tradeEnd || !twapCount) {
                alert('ëª¨ë“  ì‹œê°„ ì„¤ì •ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const timeFormat = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeFormat.test(tradeStart) || !timeFormat.test(tradeEnd)) {
                alert('ì‹œê°„ì€ HH:MM í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.\nì˜ˆ: 04:30');
                return;
            }

            if (twapCount < 1) {
                alert('TWAP CountëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const tradeStartMinutes = parseTimeToMinutes(tradeStart);
            const tradeEndMinutes = parseTimeToMinutes(tradeEnd);

            if (tradeStartMinutes >= tradeEndMinutes) {
                alert('âš ï¸ TRADE STARTëŠ” TRADE END ì‹œê°„ë³´ë‹¤ ë¹¨ë¼ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            showLoading();
            fetch('/save_all_settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    trade_start: tradeStart,
                    trade_end: tradeEnd,
                    twap_count: twapCount
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                alert(data.message || data.error);
                if (!data.error) location.reload();
            })
            .catch(error => {
                hideLoading();
                alert('Error: ' + error);
            });
        }

        function parseTimeToMinutes(timeStr) {
            const [hour, minute] = timeStr.split(':').map(Number);
            return hour * 60 + minute;
        }

        // í‹°ì»¤ ê·¸ë£¹ í† ê¸€
        function toggleTickerGroup(symbol) {
            const group = document.querySelector(`[data-ticker-group="${symbol}"]`);
            const toggleBtn = document.querySelector(`[data-ticker-toggle="${symbol}"]`);

            if (group.style.display === 'none') {
                group.style.display = 'block';
                toggleBtn.textContent = 'â–¼';
                saveExpandedState(symbol, true);
            } else {
                group.style.display = 'none';
                toggleBtn.textContent = 'â–¶';
                saveExpandedState(symbol, false);
            }
        }

        // í™•ì¥ ìƒíƒœ ì €ì¥
        function saveExpandedState(symbol, isExpanded) {
            let expandedGroups = JSON.parse(localStorage.getItem('expandedTickerGroups') || '{}');
            expandedGroups[symbol] = isExpanded;
            localStorage.setItem('expandedTickerGroups', JSON.stringify(expandedGroups));
        }

        // í™•ì¥ ìƒíƒœ ë³µì›
        function restoreExpandedStates() {
            const expandedGroups = JSON.parse(localStorage.getItem('expandedTickerGroups') || '{}');

            for (const symbol in expandedGroups) {
                if (expandedGroups[symbol]) {
                    const group = document.querySelector(`[data-ticker-group="${symbol}"]`);
                    const toggleBtn = document.querySelector(`[data-ticker-toggle="${symbol}"]`);

                    if (group && toggleBtn) {
                        group.style.display = 'block';
                        toggleBtn.textContent = 'â–¼';
                    }
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function () {
            const shortModeCheckboxes = document.querySelectorAll('input[type="checkbox"][name^="skip_sell"]');
            shortModeCheckboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    if (checkbox.checked) {
                        alert('í™œì„±í™”ì‹œ íŒë§¤ë¥¼ ìŠ¤í‚µí•˜ê³  êµ¬ë§¤ë¡œì§ë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤(ì €ì¥í•´ì•¼í•¨)');
                    }
                });
            });

            const botCards = document.querySelectorAll('.bot-card:not(.new-entry)');
            botCards.forEach(updateTotalSeed);

            // í™•ì¥ ìƒíƒœ ë³µì›
            restoreExpandedStates();
        });
    </script>
</head>
<body>
<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<div class="bot-container">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="page-header">
        <div class="page-title">
            <h1>ğŸ¤– ë´‡ ì •ë³´ ê´€ë¦¬</h1>
        </div>
        <a href="/" class="back-link">â† ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <!-- ìŠ¤ì¼€ì¤„ ì„¤ì • ì„¹ì…˜ -->
    <div class="card-section">
        <div class="section-title">â° ìŠ¤ì¼€ì¤„ ì„¤ì •</div>
        <div class="schedule-card">
            <div class="schedule-field-group">
                <div class="schedule-field">
                    <label>TRADE START</label>
                    <input type="text" name="trade_start" value="{{ trade_time }}" placeholder="HH:MM">
                </div>
                <div class="schedule-field">
                    <label>TRADE END</label>
                    <input type="text" name="trade_end" value="{{ twap_time[1] }}" placeholder="HH:MM">
                </div>
                <div class="schedule-field">
                    <label>TWAP Count</label>
                    <input type="number" name="twap_count" value="{{ twap_count }}" placeholder="ë¶„í•  íšŸìˆ˜" min="1">
                </div>
            </div>
            <div class="schedule-actions">
                <button type="button" onclick="saveAllSettings()" class="btn-success">ğŸ’¾ Save All</button>
            </div>
        </div>
    </div>

    <!-- ë´‡ ì •ë³´ ì„¹ì…˜ -->
    <div class="card-section">
        <div class="section-title">ğŸ¯ ë´‡ ëª©ë¡</div>
        {% set grouped_bots = {} %}
        {% for bot_info, tier in bot_info_with_tiers %}
            {% set symbol = bot_info.symbol %}
            {% if symbol not in grouped_bots %}
                {% set _ = grouped_bots.__setitem__(symbol, []) %}
            {% endif %}
            {% set _ = grouped_bots[symbol].append((bot_info, tier)) %}
        {% endfor %}

        {% for symbol, bots in grouped_bots.items() %}
        <!-- í‹°ì»¤ ê·¸ë£¹ í—¤ë” -->
        <div class="ticker-group-header" onclick="toggleTickerGroup('{{ symbol }}')">
            <span class="ticker-toggle" data-ticker-toggle="{{ symbol }}">â–¶</span>
            <span class="ticker-name">{{ symbol }}</span>
            <span class="ticker-count">({{ bots|length }}ê°œ)</span>
        </div>

        <!-- í‹°ì»¤ ê·¸ë£¹ ë‚´ìš© -->
        <div class="ticker-group-content" data-ticker-group="{{ symbol }}" style="display: none;">
        {% for bot_info, tier in bots %}
        <div class="bot-card">
            <div class="bot-card-header">
                <span>{{ bot_info.name }}</span>
                <div class="bot-header-toggle">
                    <label>í™œì„±í™”</label>
                    <label class="switch">
                        <input type="checkbox" name="active[{{ loop.index0 }}]" value="true" {% if bot_info.active %}checked{% endif %}>
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>
            <div class="bot-card-body">
                <!-- ê¸°ë³¸ ì •ë³´ -->
                <div class="bot-field-group">
                    <div class="bot-field">
                        <label>ì´ë¦„</label>
                        <input type="text" name="name" value="{{ bot_info.name }}">
                    </div>
                    <div class="bot-field">
                        <label>í‹°ì»¤</label>
                        <input type="text" name="symbol" value="{{ bot_info.symbol }}">
                    </div>
                    <div class="bot-field">
                        <label>í˜„ì¬ Tier</label>
                        <input type="text" value="{{ tier }}" disabled>
                    </div>
                    <div class="bot-field">
                        <label>ë°˜ë³µë¦¬ ì‹œë“œ</label>
                        <input type="text" value="{{ bot_info.added_seed }}" disabled>
                    </div>
                </div>

                <!-- Seed ì •ë³´ -->
                <div class="bot-field-group">
                    <div class="bot-field">
                        <label>1íšŒì‹œë“œ</label>
                        <input type="text" name="seed"
                               value="$ {{ '{:,.0f}'.format(bot_info.seed) if bot_info.seed else '' }}"
                               oninput="formatCurrency(this, '$ '); updateTotalSeed(this.closest('.bot-card'))">
                    </div>
                    <div class="bot-field">
                        <label>Maxí‹°ì–´</label>
                        <input type="number" name="max_tier" value="{{ bot_info.max_tier }}"
                               oninput="updateTotalSeed(this.closest('.bot-card'))">
                    </div>
                    <div class="bot-field">
                        <label>ìˆ˜ìµë¥ </label>
                        <input type="text" name="profit_rate" value="{{ bot_info.profit_rate }}" placeholder="ì†Œìˆ˜ì ">
                    </div>
                    <div class="bot-field">
                        <label>TDiv</label>
                        <input type="text" name="t_div" value="{{ bot_info.t_div }}">
                    </div>
                    <div class="bot-field">
                        <label>ì´ ì‹œë“œ</label>
                        <input type="text" name="total_seed" disabled>
                    </div>
                </div>

                <!-- ì²´í¬ ì„¤ì • -->
                <div class="bot-field-group">
                    <div class="bot-field bot-field-checkbox">
                        <label>í‰ë‹¨ê°€</label>
                        <label class="switch">
                            <input type="checkbox" name="is_check_buy_avr_price[{{ loop.index0 }}]" value="true"
                                   {% if bot_info.is_check_buy_avr_price %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="bot-field bot-field-checkbox">
                        <label>TDiv</label>
                        <label class="switch">
                            <input type="checkbox" name="is_check_buy_t_div_price[{{ loop.index0 }}]" value="true"
                                   {% if bot_info.is_check_buy_t_div_price %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="bot-field bot-field-checkbox">
                        <label>íŒë§¤ ìŠ¤í‚µ</label>
                        <label class="switch">
                            <input type="checkbox" name="skip_sell[{{ loop.index0 }}]" value="true" {% if bot_info.skip_sell %}checked{% endif %}>
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- PointLoc ë¼ë””ì˜¤ -->
                <div class="bot-field-group">
                    <div class="bot-field-radio">
                        <label class="radio-label">ì†ì ˆ ì„¤ì •</label>
                        <div class="radio-options">
                            <label><input type="radio" name="point_loc[{{ loop.index0 }}]" value="P1" {% if bot_info.point_loc== PointLoc.P1 %}checked{% endif %}> ì†ì ˆì—†ìŒ</label>
                            <label><input type="radio" name="point_loc[{{ loop.index0 }}]" value="P1_2" {% if bot_info.point_loc== PointLoc.P1_2 %}checked{% endif %}> 1/2ì§€ì </label>
                            <label><input type="radio" name="point_loc[{{ loop.index0 }}]" value="P2_3" {% if bot_info.point_loc== PointLoc.P2_3 %}checked{% endif %}> 2/3ì§€ì </label>
                        </div>
                    </div>
                </div>

                <!-- ë²„íŠ¼ -->
                <div class="bot-card-actions">
                    <button type="button" onclick="saveBotInfo(this)" class="btn-success">ğŸ’¾ Save</button>
                    <button type="button" onclick="deleteBotInfo(this, '{{ bot_info.name }}')" class="btn-danger">ğŸ—‘ï¸ Delete</button>
                </div>
            </div>
        </div>
        {% endfor %}
        </div> <!-- ticker-group-content ë‹«ê¸° -->
        {% endfor %}

        <!-- ìƒˆë¡œìš´ bot ì¶”ê°€ ì¹´ë“œ -->
        <div class="bot-card new-entry">
            <div class="bot-card-header">â• ìƒˆ ë´‡ ì¶”ê°€</div>
            <div class="bot-card-body">
                <div class="bot-field-group">
                    <div class="bot-field">
                        <label>ì´ë¦„</label>
                        <input type="text" name="name" placeholder="Enter new name">
                    </div>
                    <div class="bot-field">
                        <label>í‹°ì»¤</label>
                        <input type="text" name="symbol" placeholder="Enter new symbol">
                    </div>
                    <div class="bot-field">
                        <label>1íšŒì‹œë“œ</label>
                        <input type="text" name="seed" placeholder="Enter Seed" oninput="formatCurrency(this, '$ ')">
                    </div>
                    <div class="bot-field">
                        <label>Maxí‹°ì–´</label>
                        <input type="number" name="max_tier" placeholder="Enter Max Tier">
                    </div>
                    <div class="bot-field">
                        <label>ìˆ˜ìµë¥ </label>
                        <input type="text" name="profit_rate" placeholder="Enter profit rate">
                    </div>
                    <div class="bot-field">
                        <label>TDiv</label>
                        <input type="text" name="t_div" placeholder="Enter T Div">
                    </div>
                </div>
                <div class="bot-card-actions">
                    <button type="button" onclick="addNewBot(this)" class="btn-info">â• Add Bot</button>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
</html>
